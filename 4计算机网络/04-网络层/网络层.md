![](images/001.png)



# 一、网络层的功能

## 1. 网络层概述

### a. 网络层的特点

- **面向逻辑:** 网络层不关心数据的物理传输方式，只关心数据的逻辑传输路径。它将数据链路层封装的帧分解为更小的数据包，并根据路由选择算法确定数据包的传输路径。
- **无连接:** 网络层通常采用 **无连接** 的方式进行数据传输，即每个数据包都是独立传输的，彼此之间没有建立任何联系。如果需要可靠的数据传输，则需要在更高的传输层实现。
- **路由选择:** 网络层的主要功能之一是路由选择，即根据路由表确定数据包的传输路径。路由表通常由路由器维护，其中记录了各个网络之间的连接关系。

### b. 网络层的功能

- **寻址:** 网络层为网络中的每个设备分配一个唯一的网络地址，如IP地址。
- **路由:** 网络层根据路由表确定数据包的传输路径。
- **转发:** 网络层将数据包从一个网络设备转发到另一个网络设备。
- **拥塞控制:** 网络层可以采取措施控制网络中的数据流量，防止网络拥塞。
- **差错控制:** 网络层可以采取措施检测和纠正数据传输过程中的差错。

### c. 网络层的协议

- **IP协议:** IP协议是网络层最重要的协议，它负责在网络中传输数据包。
- **ICMP协议:** ICMP协议用于在网络设备之间传输控制信息，如错误信息和路由信息。
- **IGMP协议:** IGMP协议用于多播组成员的管理。

### d. 网络层的设备

- **路由器:** 路由器是网络层最重要的设备，它负责在网络之间转发数据包。
- **网关:** 网关是连接不同类型的网络的设备，如局域网和广域网。



## 2. SDN基本概念（选择题）

![](images/002.png)



### a. 数据平面

![](images/003.png)

### b. 控制平面 - 传统方法

![](images/004.png)

### c. 控制平面 - SDN方法

SDN: Software-Defined Networking

![](images/005.png)

#### Ⅰ. SDN中路由选择处理器

功能降低了，从主要执行，变成了通信工具。

![](images/006.png)

#### Ⅱ. SDN控制平面

![](images/007.png)

#### Ⅲ. SDN控制器的三个层次

![](images/008.png)

### d. 题目

![](images/009.png)

### e. 总结

![](images/010.png)



# 二、路由算法、路由协议

## 1. 路由算法的分类

![](images/011.png)

## 2. 分层次的路由选择协议

![](images/012.png)

![](images/013.png)



## 3. RIP协议（距离-向量算法）

* 只适合小互联网

![](images/062.png)



### a. RIP协议交换过程

* 和谁交换信息？
* 交换什么信息？
* 多久交换信息？

一个路由器最开始，只知道直接相邻的网络（距离=1），等到每隔30交换信息之后，就知道整个网络的路由信息了！！！

由于数据量特别庞大，所以只适合小网络！！！

![](images/063.png)

**具体过程**

![](images/064.png)



### b. 例题

问题一：

> 解析：
>
> R6路由表中原Net2  3  R4，收到R4新发来的 Net2  5  R4，这种情况，下一跳不变，无论距离是否增加了，也需要替换！！！

![](images/065.png)

问题二：

解析：延迟为6表示 还有额外的6跳

B -> C = (5, 0, 8 ,12, 6, 2)

即 C->B = (11, 6,  14, 18, 12, 8)

同理：如下图

![](images/066.png)



### c. RIP协议报文格式

核心：RIP协议 是应用层协议，使用UDP传送数据。

RIP报文最多包含25个路由，若网络内路由超过25个，则需要再发送一个RIP报文。

![](images/067.png)



### d. RIP协议优缺点

> **RIP协议特点：好消息传的快，坏消息传的慢！！**



**正常情况：**

![](images/068.png)



**故障情况**

> 网1出现了故障，导致不可达，但是R1 与 R2 互相发RIP消息同步数据时候，会出现先后情况！
>
> 随着时间，互相R1 与 R2 互相交换路由表，交替更新直到16才知道网1坏了。

![](images/069.png)

![](images/070.png)

![](images/071.png)



## 4. OSPF协议 及 链路状态算法

### a. OSPF协议

![](images/072.png)



### b. 链路状态路由算法

![](images/073.png)



### c. OSPF的区域

OSPF为了使用更大规模的网络，分成了若干区域。

如下图：

R6：自治系统边界路由器，负责与外网沟通；

R5、R3、R4、R7：虽然处在区域边界，也属于主干路由器；

R3、R4、R7：也叫区域边界路由器；

![](images/074.png)



### d. OSPF分组（不重要）

考纲：OSPF协议属于网络层；

![](images/075.png)



### e. OSPF特点

![](images/076.png)



## 5. BGP协议

### a. BGP协议

![](images/077.png)



### b. BGP协议交换信息的过程

不重要

核心：**交换一组路径数组的信息。**

![](images/078.png)

![](images/079.png)

![](images/080.png)

### c. BGP协议报文格式

![](images/081.png)



### d. BGP协议特点

![](images/082.png)



### e. BGP-4的四种报文

![](images/083.png)



## 6. 三种协议对比

![](images/084.png)

![](images/085.png)



# 三、IPv4

## 1. TCP/IP协议

![](images/014.png)

## 2. IP数据报格式

![](images/015.png)



### a. 首部

![](images/016.png)

说明：

1. 首部中，固定部分固定为20Byte。

2. 首部长度：占4bit，也就是 0000 - 1111，最小为5 即 0101，

    **单位为4Byte**，因为一行为32bit也就是4Byte，所以 **固定部分 + 可变部分** 一定是把一行铺满的，必须为4B的整数倍。

3. **填充**：就是为了补足成4B的整数倍。

4. 协议：TCP：6         UDP：17

![](images/017.png)



### b. IP数据报分片

#### Ⅰ、为什么要分片

![](images/018.png)

#### Ⅱ、分片用到的头部信息

![](images/019.png)

说明：

1. 标识：16bit，一个数据包拆分的分片，使用同一个标识，才知道你们是一个数据分出来的。

2. 标志：3bit，判断是否有分片。

3. 片偏移：各个分片在原数据的位置，方便重新组合成原数据。8B为单位。

    片偏移总共有 13bit，若片偏移为00.....0001，则表示该片的位置：1 * 8B = 8B，在原数据的第八个字节开始的位置。



#### Ⅲ. 分片举例

![](images/020.png)

说明：

片偏移 = 数据开始的位置 / 8B     （8B是固定单位）



### c. 数据报中三个固定单位

![](images/021.png)



## 3. IPv4地址

### a. IP地址的历史阶段

* 分类的IP地址：每个设备都分配一个，但是后来不够用了；（也就是本节的内容）
* 子网的划分：设备太多，32bit的IP地址不够分了，从而推出的新方案；（后面章节的内容）
* 构成超网（无分类编址方案）：CIDR（后面章节的内容）



### b. IP地址的简介

连接到互联网上的每台主机或路由器都分配了一个32bit的全球唯一的标识符，即IP地址。

* IP地址：全球唯一，
* IP地址并不是标识一个主机，而是标识 **主机/路由器 的一个接口**，如果一个**主机/路由器** 有多个接口，则需要分配多个IP地址。
* IP地址：{<网络号>,  <主机号>}
    * 网络号：标志主机 / 路由器所链接到的网络；**一个网络号在整个因特网范围内必须是唯一的。**
    * 主机号：标志该主机 / 该路由器



**互联网中的IP地址**

![](images/022.png)

说明：

网桥：能隔离冲突域，并不能隔离广播域，所以右下角整体还是一个局域网，所以只能一个网络号。



### c. IP地址的分类

![](images/023.png)

#### Ⅰ. 特殊的IP地址

![](images/024.png)

说明：

* 32位全0：表示本网络上的本主机
* 32位全1：即255.255.255.255表示整个TCP/IP 网络的广播地址，又称为**受限广播地址**。实际使用中，由于路由器对广播域的隔离，255.255.255.255等效于本网络的广播地址。

* 主机号全0：本网络本身，如 202.98.174.0
* 主机号全1：本网络的广播地址，又称为**直接广播地址**，如 202.98.174.255
* 127.0.0.0：保留为 环回地址，地址表示任意主机本身，目的地址为环回地址的IP数据报不会出现在任何网络上。



#### Ⅱ. 私有IP地址

![](images/025.png)

* 为了网络安全，划分部分IP地址为私有IP地址。**私有IP地址只能用于LAN。**

* 私有IP地址需要使用NAT技术，才能对外通信。
* 私有IP地址的好处：
    * 使得整个专用网络只需要一个全球IP地址就可以与因特网连接。
    * 由于专用网络内部的IP地址是可以重用的，大大降低了IP的消耗。



#### Ⅲ. 可用数量

![](images/026.png)

说明：

**网络号：**

A类：网络号 0000 0000 (**保留地址，意思是“本网络”**) 与 0111 1111 (**保留地址，环回地址，保留作为本地软件环回测试，本主机的进程之间的通信之用**) 不可用；

B类：网络号 128.0 不可用；

C类：网络号：192.0.0 不可用；



**主机号：**

A、B、C类：**x.x.x.0：本网络本身** 和 **x.x.x.255：本网络广播地址**，所以不可用。

> ​		不管是A类还是B类还是C类网络，在不划分子网的情况下，有两个IP地址不可用： 网络号和广播地址。比如在一个没有划分子网的C类大网中用**202.203.34.0来表示本网络本身，用202.203.34.255来表示本网络广播地址**，因为C类大网的IP地址有256个，现在减去这两个IP地址，那么可用的IP地址就只剩下256-2=254个了。如果题目问：把一个C类大网划分为4个子网，有多少个不可用的IP地址？可以这样想：在C类大网不划分子网时，有两个IP地址不可用；现在将C类大网划分为4个子网，那么每个子网中都有2个IP地址不可用，所以4个子网中就有8个IP地址不可用。



## 4. 网络地址转换 NAT

### a. 私有IP如何与外部网络通信？

![](images/027.png)

方案：专用网中，必须有一个**NAT路由器**，NAT必须有一个**全球IP**（也可以有多个全球IP）。

![](images/028.png)

### b. 私有IP与外部通信过程

#### Ⅰ.自总结⭐️

1. A主机发送消息给B主机，

    `A信息：源地址（A主机：192.168.0.3）+ 目的地址（B主机：213.18.2.4）+ 端口号（进程号：30000）`

2. 到了NAT路由器，根据NAT转换表，将 **原地址 与 端口号** 进行替换

    `NAT信息：源地址（NAT的外网IP地址：173.38.1.5） + 目的地址（不变） + 端口号（NAT的端口号：40001）`

3. 新数据可以在因特网上转发，到了B主机，B主机可以整理信息返回给A

    `B信息：源地址（B主机的IP）+ 目的地址（接受到的NAT的IP：173.38.1.5）+ 端口号（接受到的NAT的端口号40001）`

4. NAT路由器接受到B的信息后，根据NAT转发表，再将信息替换为内部IP信息。



#### Ⅱ. GPT答案

```
私有IP地址是指在本地网络中使用的IP地址，无法在互联网中直接路由。为了使使用私有IP地址的设备能够与互联网通信，需要进行网络地址转换（NAT，Network Address Translation）。以下是详细过程：

### 1. 私有IP地址与NAT的概念
- **私有IP地址**：常见的私有IP地址范围包括：
  - 10.0.0.0 到 10.255.255.255
  - 172.16.0.0 到 172.31.255.255
  - 192.168.0.0 到 192.168.255.255
- **NAT**：NAT是一种在路由器或防火墙上实现的功能，用于在私有IP地址和公共IP地址之间进行转换。

### 2. 设备发送数据包到互联网
- 设备在本地网络中使用私有IP地址发送数据包，数据包的源IP地址是该设备的私有IP。
- 数据包到达网络边界的NAT设备（如路由器）。

### 3. NAT设备处理数据包
- NAT设备记录原始源IP地址和端口号。
- NAT设备将私有IP地址转换为公共IP地址，并更改数据包的源IP地址为路由器的公共IP地址，同时也可能修改源端口号。
- 修改后的数据包被发送到互联网。

### 4. 互联网目的地处理数据包
- 互联网服务器接收到数据包后，会看到请求来自路由器的公共IP地址和相应的端口号。
- 服务器根据请求进行响应，并将响应数据包发送到NAT设备的公共IP地址。

### 5. NAT设备将数据包发送回私有网络中的设备
- NAT设备接收到服务器响应的数据包。
- 根据之前记录的NAT映射表，NAT设备将数据包的目标IP地址和端口号转换回原始的私有IP地址和端口号。
- 数据包被发送回最初发送请求的设备。

### 6. 设备接收数据包
- 私有网络中的设备接收到来自互联网的响应数据包，完成一次完整的通信过程。

### 示例
假设有一台在私有网络中的计算机，其IP地址为192.168.1.2，需要访问位于互联网的服务器，其IP地址为8.8.8.8，过程如下：

1. 计算机192.168.1.2发送数据包到8.8.8.8，数据包源IP为192.168.1.2，目的IP为8.8.8.8。
2. 路由器接收数据包，将源IP从192.168.1.2转换为路由器的公共IP（例如203.0.113.5），并记录NAT映射关系。
3. 路由器将修改后的数据包发送到互联网。
4. 服务器8.8.8.8接收到数据包，处理请求后，将响应数据包发送到203.0.113.5。
5. 路由器接收响应数据包，查询NAT映射表，将目标IP从203.0.113.5转换回192.168.1.2，并发送数据包回计算机。
6. 计算机192.168.1.2接收到响应数据包。

通过NAT机制，私有IP地址的设备可以安全地与互联网进行通信，同时保持本地网络的私密性和安全性。
```



## 5. 子网划分

### a. 为什么推出子网划分

子网的划分：设备太多，32bit的IP地址不够分了，从而推出的新方案；（后面章节的内容）

![](images/029.png)



### b. 如何子网划分？

注意点

* 划分子网后，对外仍表现为一个网络，外网看不到内网的子网划分；
* 子网号能否全0全1：
    * 最开始不可以；
    * 后面出现了CIDR，就可以了；
* 主机号最少几位：2位
    * 若为1位，也就是0 / 1，此时0表示本网络，1表示广播分组，划分子网无意义！！

![](images/030.png)



### c. 子网掩码

如下图：

此时外网向 **145.13.3.10** 发送消息，消息到NAT（145.13.0.0），NAT如何知道消息发送给哪个子网？？？

此时就需要 **子网掩码** 来确定 **网络号** 或 **子网号**。

![](images/031.png)

#### Ⅰ. 二级IP的子网掩码

可以得到：网络号 + 主机号

* 网络号：IP地址 + 子网掩码    （按位与）
* 主机号：IP地址 + 子网掩码补码 （按位与）



![](images/032.png)



#### Ⅱ. 三级IP的子网掩码

可以得到，子网的网络地址。

先将IP地址转为二进制，子网掩码也要是二进制形式。

按位与，两个都是1才是1，否则都为0。如：00101010 & 111111111 = 00101010

![](images/033.png)



#### Ⅲ. 子网掩码 题目

`已知IP地址是141.14.72.24，子网掩码是255.255.192.0，求网络地址。若子网掩码为255.255.224.0，求子网掩码。`

解：都转为二进制

（1）IP中72 = 0100 1000，子网掩码中192 = 1100 0000

相与 = 0100 0000 = 64

所以第一个子网网络地址：141.14.64.0

（2）IP中72 = 0100 1000，子网掩码中224 = 1110 0000

相与 = 0100 0000 = 64

> 发现：
>
> 不同的掩网子码，可以得到相同的子网地址；
>
> 但是，它们的主机号的数量是不同的！！！！
>
> 如：子网掩码255.255.192.0 = 1111 1111.  1111 1111.  1100 0000.  0000 0000，他的子网网络号共18位，主机号共14位；
>
> 子网掩码225.225.224.0 = 1111 1111.  1111 1111.  1110 0000.  0000 0000，他的子网网络号共19位，主机号共13位；



【常见】

![](images/034.png)

#### Ⅳ. 子网掩码 真题

> 某主机的IP地址为180.80.77.55，子网掩码255.255.252.0。若该主机向其所在子网发送广播分组，则目的地址可以是（）
>
> A. 180.80.76.0    B. 180.80.76.255   C. 180.80.77.255     D. 180.80.79.255

我选B，❎

```
我的思路：先计算子网号
都转二进制
77 = 0100 1101 
252 = 1111 1100
相与 = 0100 1100 = 76
广播：1111 1111 = 255
所以目的地址：180.80.76.255   ❎

正确思路：
1.子网掩码252 = 1111 1100，表示子网网络号有6位 ✔️
2.IP与子网掩码相与，得到子网网络号：180.80.76.0，这一步是没问题的 ✔️
3.（180表示是B类IP（128-192），所以网络号是前16位，也就是 180.80.0.0）
4.此刻广播，需要主机号都是1
5.子网网络号（16位 + 6位） + 子网主机号（10位，全1） = 180.80.（子网号：0100 11）+ (主机号：11) .1111 1111
```

![](images/035.png)



### d. 使用子网时，分组的转发

![](images/036.png)

## 6. 无分类编址CIDR

### a. 为什么出现CIDR

1. B类地址很快被分配完了；
2. 路由表中的项目急剧增加！导致难以维护！！！



### b. CIDR介绍

核心：

1. 消除了传统A类、B类、C类地址的划分以及子网的概念；
2. 融合子网地址与子网掩码，方便子网划分；

![](images/037.png)

#### CIDR例题

CIDR地址：192.199.170.80 / 27，问：

1. 该地址包括多少个IP地址？

> 快网络号27位，主机号5位，所以可以有2的5次方个主机 = 32个IP地址

2. 该地址块的最小地址min 与 最大地址是什么？

> 最小地址：主机号全0
>
> 最大地址：主机号全1

3. 该CIDR地址块是多少？

> 用上一题的最小地址，代表本网络。

4. CIDR的地址掩码（子网掩码）是多少?

> 网络号全1，主机号全0
>
> 前27位全1，后5位全0



### c. 构成超网

将多个子网聚合成一个大的子网。

如下图:

有路由器R1、R2，R2连接两个子网，R1发送信息给R2。R1的端口都是接口a，所以路由表中会有两个记录，后面可能有更多的记录，无法整理。

所以通过路由聚合的方法，将路由表缩短。



206.1.0.0 / 17    和   206.1.128.0 / 17       **取交集**

206.1.0000 0000 . 0000 0000

206.1.1011 1111 . 0000 0000

取交集，前16位是一样的，所以合体后的网络地址为 206.1.0.0 / 16

![](images/038.png)

**例题**

![](images/039.png)



### d. 最长前缀匹配

可能匹配到多个结果，需要选择前缀最长的那个。

如下图：

使用CIDR，进来一个信息，目的地址：206.0.71.130，查找路由表，查看应该转发给哪个子网。

方法一：分别计算三个网络的 子网络号，最后与目标地址的二进制进行对比，子网号部分是否相同；

方法二：目的地址分别与 三个网络的子网掩码进行相与，得到子网网络号，分别与对应CIDR的IP地址进行对比。

![](images/040.png)

**例题**

![](images/041.png)



## 7. ARP协议

### a. ARP协议工作过程

#### Ⅰ.本网络内部

如下图：1号主机与3号主机进行通信；

1主机内有ARP高速缓存，IP地址与Mac地址映射。

![](images/042.png)

#### Ⅱ. 外部网络

这里集线器 + 交换机 组成内部网络，集线器与交换机是没有Mac地址的；

转发到路由器的默认网关。

![](images/043.png)



### b. ARP协议介绍

![](images/044.png)



### c. 题目

![](images/045.png)



## 8. DHCP协议

### a. 主机如何获取IP地址的？

方式一：静态配置，教室、公司都是静态分配，**固定的IP地址 + 固定的子网掩码 + 固定的默认网关**

 方式二：动态配置，进入家里，自动连接上家里的网络。

![](images/046.png)



### b. DHCP动态分配过程

核心：

1. DHCP是应用层协议，使用 **客户/服务器** 方式；
2. **广播** 方式进行交互；
3. 动态分配IP的过程，基于**UDP**。

![](images/047.png)



## 9. ICMP协议

#### Ⅰ. ICMP协议介绍

ICMP协议是介于 网络层与传输层之间的协议，是为了更有效的转发与提交交付。

ICMP协议，主要是对有差错的报文进行反馈，发送特定的ICMP报文。

![](images/050.png)

![](images/048.png)



#### Ⅱ. ICMP差错报文

##### ICMP差错报告报文的5种情况

![](images/049.png)

##### ICMP差错报告报文数据字段

![](images/051.png)

##### 不应该发送ICMP差错报文的情况

选择题考察！

![](images/052.png)





#### Ⅲ. ICMP询问报文

![](images/053.png)



#### Ⅳ. ICMP的应用

![](images/054.png)



# 四、IPv6

## 1. 为什么有 IPv6 ?

IPv6有哪些优势：

* 改进首部格式
* 可以快速处理、转发数据报
* 支持QoS

![](images/055.png)

## 2. IPv6 数据报格式

![](images/056.png)

![](images/057.png)



## 3. IPv6 vs IPv4

![](images/058.png)

## 4. IPv6 地址表现形式

![](images/059.png)



## 5. IPv6基本地址类型

![](images/060.png)

## 6. IPv6 向 IPv4 过渡的策略

* 隧道技术：就是将IPv6数据报，当做IPv4的数据，再封一层！

![](images/061.png)





# 五、IP组播

## 1. 单播、广播、组播

![](images/086.png)

### a. 举个例子

![](images/087.png)

![](images/088.png)



## 2. IP组播地址

组播地址：也就是IP地址分类提到的D类IP地址。

组播地址只能用于目的地址，源地址总是单播地址。

![](images/089.png)







# 六、移动IP





# 七、网络层设备















